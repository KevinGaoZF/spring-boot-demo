<!DOCTYPE html>
<html>
<head>
  <title>币种数据-2</title>
  <meta charset="UTF-8">
    <style>
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .row {
            display: flex;
            align-items: center; /* 垂直居中对齐 */
        }
        .controls {
            /*display: flex;*/
            /*flex-direction: row;*/
            gap: 10px;
        }
        .input {
            width: 180px;
            height: 40px;
        }
        .button {
            width: 80px;
        }
        .box {
            width: 200px;
            height: 260px;
            background-color: lightgray;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            border: beige 1px solid;
            padding: 5px;
        }
        .pair_href{
            margin-left: 15px;
            margin-right: 15px;
        }
    </style>
</head>
<body>
<div class="container" id="dynamicContainerTaskAdd">
</div>
<div>
    <input type="input" placeholder="请输入用户ID" id="user_id" value=""/>
    <button onclick="login()" >登录用户</button>
    <button style="width: 200px;height: 80px;border-radius: 5px;background-color: aliceblue" onclick="addRow()">
        增加任务
    </button>
    <button style="width: 200px;height: 80px;border-radius: 5px;background-color: aliceblue" onclick="loadData()">
        刷新数据
    </button>
</div>

<div>
    <h1 id="updateTime"></h1> <!-- 添加更新时间 -->
</div>
<div class="container" id="dynamicContainer">
</div>

<script>
    // 模拟从服务器获取的多行数据数组
    let responseData = [
        ['页面初始化']
    ]
    const addTableData = [
        ['暂无数据']
    ];

    const inputText = ['代币：','间隔：','次数：','任务：','名称：'];

    let j = 0;

    function login(){
        var userId = document.getElementById("user_id").value;
        sessionStorage.setItem("userId",userId);
        alert("登录成功！");
    }

    function login_chk(){
        if(sessionStorage.getItem("userId")){
            document.getElementById("user_id").value = sessionStorage.getItem("userId");
            console.log("用户登录+"+sessionStorage.getItem("userId"));
            return true;
        } else {
            console.log("未登录");
            alert("请输入用户名登录");
            return false;
        }

    }

    login_chk();

    function loadTable(loadTableData,addFlag) {
        login_chk();
        // 获取容器元素
        let container = document.getElementById('dynamicContainer');
        if(addFlag){
            container = document.getElementById('dynamicContainerTaskAdd');
        }


        // 遍历多行数据数组

        loadTableData.forEach(rowData => {
            const row = document.createElement('div');
            row.className = 'row';

            // 创建左侧的控件容器
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'controls';

            const inputs = [];
            // 创建输入框
            for (let i = 0; i < 5; i++) {
                const div = document.createElement('div');
                const span = document.createElement('span');
                const input = document.createElement('input');
                span.textContent = inputText[i];
                input.type = 'text';
                input.className = 'input row_'+j;
                input.id='row_'+j+'_col_'+i;

                if(rowData.taskRecord ){
                    if(i == 0) {
                        input.value=rowData.taskRecord.token;
                    } else if ( i == 1) {
                        input.value=rowData.taskRecord.execTime;
                    } else if ( i == 2) {
                        input.value=rowData.taskRecord.execNum;
                    } else if ( i == 3) {
                        input.value=rowData.taskRecord.taskNo;
                    } else if ( i == 4) {
                        input.value=rowData.taskRecord.tokenName;
                    }
                    input.disabled= true;

                }
                div.appendChild(span);
                div.appendChild(input);
                controlsContainer.appendChild(div);

                inputs.push(input); // 将输入框添加到数组中
            }


            // 创建按钮
            const button = document.createElement('button');
            const buttonDetail = document.createElement('button');


            button.className = 'button';
            buttonDetail.className = 'button-detail';
            button.id='row_'+'j';



            // 创建右侧的<div>元素
            let executeRecList = rowData;
            if(executeRecList && executeRecList.executeRecordList) {
                executeRecList = rowData.executeRecordList;
                button.textContent = '删除任务';
                button.style.backgroundColor = "red";
                button.style.color = "white";
                // 添加 onclick 事件
                button.onclick = () => {
                    alert('确认删除？'+rowData.taskRecord.taskNo); // 按钮被点击时触发的操作
                    deleteTask(rowData.taskRecord.taskNo);
                };
                const pairPreviewUrl = document.createElement('a');
                pairPreviewUrl.href="https://dexscreener.com/ethereum/"+rowData.taskRecord.pair;
                pairPreviewUrl.text = "pair查看连接";
                pairPreviewUrl.className='pair_href';
                pairPreviewUrl.setAttribute("target","_blank");
                controlsContainer.appendChild(pairPreviewUrl);
            } else {
                if(addFlag){
                    // 添加 onclick 事件
                    button.textContent = '启动任务';
                    button.onclick = () => {
                        alert('任务启动指令已发出!'); // 按钮被点击时触发的操作
                        const inputValues = inputs.map(input => input.value); // 获取输入框的值
                        console.log(inputValues)
                        execTask(inputValues[2],inputValues[1],inputValues[0],inputs[3]);
                    };
                } else {
                    button.textContent = '删除任务';
                    button.style.backgroundColor = "red";
                    button.style.color = "white";
                    // 添加 onclick 事件
                    button.onclick = () => {
                        alert('确认删除？'+rowData.taskRecord.taskNo); // 按钮被点击时触发的操作
                        deleteTask(rowData.taskRecord.taskNo);
                    };
                }
                executeRecList = ['暂无数据'];
            }
            buttonDetail.textContent = '查询进度';
            buttonDetail.onclick = () => {
                taskExecuteDetail(rowData.taskRecord.taskNo);
            };
            buttonDetail.style.backgroundColor = "green";
            buttonDetail.style.color = "white";



            controlsContainer.appendChild(button);
            controlsContainer.appendChild(buttonDetail);


            row.appendChild(controlsContainer);

            executeRecList.forEach(data => {
                const div = document.createElement('div');
                const span = document.createElement('span');
                // const span2 = document.createElement('span');
                div.className = 'box';
                if(data.successTime) {
                    span.textContent = "第"+data.execFlag+"次："+data.successTime
                        +" token："+data.tokenResult+" other："+data.otherResult
                        +" holder："+data.holder+" th："+data.aveHolders
                        +" Change："+data.avePriceChange
                        +" AAT："+data.totalHolderPercent
                        +" BBH："+data.totalTotalPercent
                        +" VM："+data.volume;
                    if(data.colorFlag == 3){
                        div.style.backgroundColor = "red";
                    } else if (data.colorFlag == 2){
                        div.style.backgroundColor = "yellow";
                    } else if (data.colorFlag == 1){
                        div.style.backgroundColor = "green";
                    } else if (data.colorFlag == 4){
                        div.style.backgroundColor = "orange";
                    }
                } else {
                    span.textContent = data;
                }


                div.appendChild(span);
                row.appendChild(div);
            });

            container.appendChild(row);
            j++;
        });

    }
    loadTable(responseData);
    function addRow(){
        login_chk();
        document.getElementById('dynamicContainerTaskAdd').innerHTML='';
        loadTable(addTableData,true);
    }
    /**
     * 任务创建操作
     * @param {string} execNumber execNumber
     * @param {string} timeInterval timeInterval
     * @param {string} token token
     * @returns
     */
    function execTask(execNumber, timeInterval, token,taskInput) {
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        login_chk();
        var userId = sessionStorage.getItem("userId");
        fetch("/spider/coin-data/exec-task/"+userId+"/?execNumber="+execNumber+"&timeInterval="+timeInterval+"&token="+token, requestOptions)
            .then(response => response.text())
            .then(result => {
                console.log(result);
                taskInput.value=result;
            })
            .catch(error => console.log('error', error));
    }

    function deleteTask(taskNo) {
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        fetch("/spider/coin-data/task-delete/"+taskNo, requestOptions)
            .then(response => response.text())
            .then(result => {
                console.log(result);
                alert(taskNo+"删除成功");
                loadData();
            })
            .catch(error => console.log('error', error));
    }

    function taskExecuteDetail(taskNo) {
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        fetch("/spider/coin-data/task-detail/"+taskNo, requestOptions)
            .then(response => response.text())
            .then(result => {
                console.log(result);
                alert(result);
            })
            .catch(error => console.log('error', error));
    }

    function loadData(){
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        var userId = sessionStorage.getItem("userId");

        fetch("/spider/coin-data/task-list/"+userId, requestOptions)
            .then(response => response.text())
            .then(result => {
                console.log(result);
                responseData = JSON.parse(result).data;
                document.getElementById('dynamicContainer').innerHTML='';
                loadTable(responseData);
                updateTime();
            })
            .catch(error => console.log('error', error));
    }

    // 获取当前时间
    function getCurrentTime() {
        let date = new Date();
        let hours = date.getHours().toString().padStart(2, '0');
        let minutes = date.getMinutes().toString().padStart(2, '0');
        let seconds = date.getSeconds().toString().padStart(2, '0');

        return `${hours}:${minutes}:${seconds}`;
    }
    // 更新时间
    function updateTime() {
        // 获取更新时间的元素
        let updateTimeElement = document.getElementById('updateTime');
        updateTimeElement.textContent = "页面更新时间：" + getCurrentTime();
    }

    function startTask(row){
        console.log(row);
    }
    // 定义刷新时间间隔（以毫秒为单位）
    const refreshInterval = 60*1000;
    // 定时刷新表格数据
    setInterval(loadData, refreshInterval);
</script>

</body>
</html>